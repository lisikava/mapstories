<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE-edge">
    <meta name="viewpoint" content="width=device-width, initial-scale=1.0">
    <title>Map Stories</title>
    <!-- Include leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

    <link rel="stylesheet" href="style.css">  

</head>

<body>
    <nav>
        <div class="app-name">MapStories</div>
        <div class="lasso">
            <div class="lasso-text">
              Search
            </div>
            <div class="lasso-wrap">
              <div class="lasso-triangle">
              </div>
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="58px" height="58px" viewBox="0 0 16 16" preserveAspectRatio="none">
                <circle cx="8" cy="8" r="6.215" transform="rotate(90 8 8)"></circle>
                <image href="https://uxwing.com/wp-content/themes/uxwing/download/user-interface/search-icon.svg" x="5.2" y="5.5" width="6" height="6", fill="#de7813" />
              </svg>
             </div>
            <div class="lasso-border">
            </div>
          </div>
          
    </nav>
    <div id="map"></div>
    <div id="pins-description-container" class="hidden">
        <div id="description-container">
            <div class="description-input-group">
                <input type="text" id="description-input" placeholder="Enter description">
            </div>
        </div>
        <div class="controls">
            <button type="button" id="add-cell" class="add-cell">+</button>
            <button type="button" id="cancel-description" class="cancel-description">Cancel</button>
            <button type="button" id="submit-description" class="submit-description">Submit</button>

        </div>
    </div>
</body>

<script>
    var map = L.map('map', {
        center: [50.065870, 19.934727],
        zoom: 12,
        zoomControl: false,
        attributionControl: false
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
    }).addTo(map);

    const pin_icon = L.icon({
        iconUrl: './assets/pin-3.svg',
        iconSize: [40, 40],
    });

        const pins_Description_Container = document.getElementById('pins-description-container');
        const description_Container = document.getElementById('description-container');
        const add_Cell_Button = document.getElementById('add-cell');
        const submit_Description_Button = document.getElementById('submit-description');
        const cancel_Description_Button = document.getElementById('cancel-description');

        let current_pin;
        let form_Open = false;
        const all_Descriptions = [];
        const placed_pins = [];

        function remove_listeners(){
            add_Cell_Button.removeEventListener('click', add_Description_Handler);
            submit_Description_Button.removeEventListener('click',submit_Description_Handler);
            cancel_Description_Button.removeEventListener('click', cancel_Description_Handler);        
        }

        function addListeners() {
            add_Cell_Button.addEventListener('click', add_Description_Handler);
            submit_Description_Button.addEventListener('click', submit_Description_Handler);
            cancel_Description_Button.addEventListener('click', cancel_Description_Handler);
        }
        const add_Description_Handler = function(){
                    const new_Description_Input = document.createElement('div');
                    new_Description_Input.classList.add('description-input-group');
                    new_Description_Input.innerHTML = '<input type="text" class="description-input" placeholder="Enter description">';
                    description_Container.appendChild(new_Description_Input);
                };
        /*const submit_Description_Handler = function(){
                    const description_Inputs = description_Container.querySelectorAll('.description-input');
                    const current_Pin_Descriptions = Array.from(description_Inputs)
                        .map(input => input.value)
                        .filter(value => value.trim() !== '');
                    if (current_Pin_Descriptions.length > 0) {
                        const popup_Content = current_Pin_Descriptions.join('<br><hr>');
                        current_pin.bindPopup(popup_Content).openPopup();
                        all_Descriptions.push(current_Pin_Descriptions);
                    } else {
                        map.removeLayer(current_pin);
                    }    
                    pins_Description_Container.classList.add('hidden');
                    current_pin = null;
                    form_Open = false;
                    remove_listeners();
                };*/

        const submit_Description_Handler = function(){
                    const description_Inputs = description_Container.querySelectorAll('.description-input');
                    const current_Pin_Descriptions = Array.from(description_Inputs)
                        .map(input => input.value)
                        .filter(value => value.trim() !== '');

                    if (current_Pin_Descriptions.length > 0) {
                        const popup_Content = current_Pin_Descriptions.join('<br><hr>');
                        current_pin.bindPopup(popup_Content).openPopup();
                        placed_pins.push({pin: current_pin, tags: current_Pin_Descriptions});
                    } else {
                        map.removeLayer(current_pin);
                    }    
                    pins_Description_Container.classList.add('hidden');
                    current_pin = null;
                    form_Open = false;
                    remove_listeners();
                };        

        const cancel_Description_Handler = function(){
                    map.removeLayer(current_pin);
                    pins_Description_Container.classList.add('hidden');
                    current_pin = null;
                    form_Open = false;
                    remove_listeners();
                };  
                
        function display_Pin_Content(descriptions){
            description_Container.innerHTML = '';
            if (descriptions && descriptions.length > 0) {
                descriptions.forEach(desc => {
                    const description_Div = document.createElement('div');
                    description_Div.classList.add('description-input-group');
                    description_Div.textContent = desc;
                    description_Container.appendChild(description_Div);
                });
                pins_Description_Container.classList.remove('hidden');
            } else{
                pins_Description_Container.classList.add('hidden');
            }
        } 
        /*
        map.on('click', function(e) {
            let pin_Clicked = false;
            placed_pins.forEach(pin_content => {
                if (e.layerPoint && pin_content.pin.getLatLng().equalst(e.latlng)) {
                    display_Pin_Content(pin_content.tags);
                    pin_Clicked = true;
                }
            })

            if (!pin_Clicked && !form_Open){
                form_Open = true;
                pins_Description_Container.classList.remove('hidden');
                description_Container.innerHTML = `
                    <div class="description-input-group">
                        <input type="text" class="description-input" placeholder="Enter description">
                    </div>    
                `;
                description_Container.scrollTop = 0;
                current_pin = L.marker(e.latlng, { icon: pin_icon }).addTo(map);
                addListeners();
            } else if (!pin_Clicked && form_Open) {
                pins_Description_Container.classList.add('hidden');
                form_Open = false;
                if (current_pin){
                    map.removeLayer(current_pin);
                    current_pin(null);
                    remove_listeners();
                }
            }

        }); */
        
        
        
        
        map.on('click', function(e) {
            if (!form_Open){
                form_Open = true;
                pins_Description_Container.classList.remove('hidden');
                description_Container.innerHTML = `
                    <div class="description-input-group">
                        <input type="text" class="description-input" placeholder="Enter description">
                    </div>    
                `;
                description_Container.scrollTop = 0;
                current_pin = L.marker(e.latlng, { icon: pin_icon }).addTo(map);

                addListeners();

            }

        });
</script>    
</html>